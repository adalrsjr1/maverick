<source>
  # http://docs.fluentd.org/articles/in_http
  type http
  port 9880
</source>

<source>
  type monitor_agent
  port 24220
</source>

<source>
  # http://www.fluentd.org/guides/recipes/docker-logging
  # https://docs.docker.com/compose/compose-file/
  # https://docs.docker.com/engine/admin/logging/log_tags/
  type forward
  port 24224
  bind 0.0.0.0
</source>

<source>
  type amqp
  host "#{ENV['RABBITMQ_SOURCE']}"
  port 5672
  vhost /
  user guest
  pass guest
  key "#{ENV['FLUENTD_RABBITMQ_SOURCE_KEY']}"
  tag_key "#{ENV['FLUENTD_RABBITMQ_SOURCE_TAG_KEY']}"
  tag "#{ENV['FLUENTD_RABBITMQ_SOURCE_TAG']}" #fluentd log tag
  queue "#{ENV['FLUENTD_RABBITMQ_SOURCE_QUEUE']}"
  format json
  exchange "#{ENV['FLUENTD_RABBITMQ_SOURCE_EXCHANGE']}"
  routing_key "#{ENV['FLUENTD_RABBITMQ_ROUTING_KEY']}"

</source>

<match monitor.**>
  #  https://github.com/project-hatohol/fluent-plugin-sort
  @type copy

  <store>
    # std output
    @type stdout
  </store>

  <store>
    # Rabbitmq output https://github.com/giraffi/fluent-plugin-amqp
    @type amqp
    host "#{ENV['RABBITMQ_MATCHER']}"
    port 5672
    user guest
    pass guest
    vhost /
    tag_key "#{ENV['FLUENTD_RABBITMQ_MAVERICK_MATCHER_TAG_KEY']}"
    exchange "#{ENV['FLUENTD_RABBITMQ_MAVERICK_MATCHER_EXCHANGE']}"
    exchange_type "#{ENV['FLUENTD_RABBITMQ_MAVERICK_MATCHER_EXCHANGE_TYPE']}"
    key "#{ENV['FLUENTD_RABBITMQ_MAVERICK_MATCHER_KEY']}"
    content_type "#{ENV['FLUENTD_RABBITMQ_MAVERICK_MATCHER_CONTENT_TYPE']}"
    flush_interval 0s
    num_threads 2
  </store>
</match>

<match docker.**>
  #  https://github.com/project-hatohol/fluent-plugin-sort
  @type copy

  <store>
    # std output
    @type stdout
  </store>

  <store>
    # Rabbitmq output https://github.com/giraffi/fluent-plugin-amqp
    @type amqp
    host "#{ENV['RABBITMQ_MATCHER']}"
    port 5672
    user guest
    pass guest
    vhost /
    tag_key "#{ENV['FLUENTD_RABBITMQ_DOCKER_MATCHER_TAG_KEY']}"
    exchange "#{ENV['FLUENTD_RABBITMQ_DOCKER_MATCHER_EXCHANGE']}"
    exchange_type "#{ENV['FLUENTD_RABBITMQ_DOCKER_MATCHER_EXCHANGE_TYPE']}"
    key "#{ENV['FLUENTD_RABBITMQ_MAVERICK_DOCKER_KEY']}"
    content_type "#{ENV['FLUENTD_RABBITMQ_DOCKER_MATCHER_CONTENT_TYPE']}"
    flush_interval 0s
    num_threads 2
  </store>
</match>